<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteFinder v10 üöÄ</title>

    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #121212;
            margin: 0;
            padding: 20px;
            color: #EFEFEF;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: #1E1E1E;
            border-radius: 12px;
            border: 1px solid #3B3B3B;
            overflow: hidden;
        }

        header {
            background-color: #282828;
            color: white;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 1px solid #3B3B3B;
        }

        h1 { margin: 0; font-size: 2em; }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 800px;
        }

        .sidebar {
            padding: 20px;
            border-right: 1px solid #3B3B3B;
            overflow-y: auto;
            background: #181818;
        }

        .map-area {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            width: 100%;
            background-color: #242f3e;
        }

        /* --- DASHBOARD STYLES (NEW) --- */
        .dashboard-bar {
            background: #222;
            border-bottom: 1px solid #444;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            display: none; /* Hidden until calc */
        }
        .stat-box {
            display: flex;
            gap: 15px;
        }
        .stat-item {
            color: #aaa;
        }
        .stat-item strong {
            color: #fff;
            font-size: 1.1em;
        }

        /* Zip Code Dropdown */
        .zip-dropdown {
            position: relative;
            display: inline-block;
        }
        .zip-btn {
            background: #333;
            color: #ddd;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .zip-btn:hover { background: #444; }
        .zip-content {
            display: none;
            position: absolute;
            right: 0;
            top: 35px;
            background: #222;
            min-width: 280px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            z-index: 2000;
            border: 1px solid #444;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .zip-content.show { display: block; }
        .zip-row {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .zip-row:last-child { border-bottom: none; }
        .zip-tag {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            color: #fff;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Controls */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #B3B3B3; font-size: 0.9em; }
        input, select { padding: 10px; border: 1px solid #535353; background-color: #3B3B3B; color: #FFFFFF; border-radius: 6px; width: 100%; box-sizing: border-box; }
        textarea { padding: 10px; border: 1px solid #535353; background-color: #3B3B3B; color: #FFFFFF; border-radius: 6px; width: 100%; box-sizing: border-box; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; resize: vertical; }
        textarea:focus { outline: none; border-color: #fca311; }
        button { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        .btn-action { background-color: #fca311; color: #121212; }
        .btn-action:hover { background-color: #e89300; }
        .btn-secondary { background-color: #2a9d8f; color: white; }
        .btn-auto { background-color: #7209b7; color: white; }
        .btn-reset { background-color: #444; color: white; margin-bottom: 10px; }
        .btn-parse { background-color: #3a86ff; color: white; }
        .btn-parse:hover { background-color: #2667cc; }
        .btn-clear { background-color: #555; color: #ccc; font-size: 0.85em; }

        .driver-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #333; font-size: 0.9em; background: #222; margin-bottom: 2px; border-radius: 4px; }
        .btn-remove-driver { background-color: #d90429; color: white; border: none; border-radius: 4px; padding: 4px 10px; cursor: pointer; font-weight: bold; font-size: 1.1em; width: auto; margin: 0; line-height: 1; }
        .btn-remove-driver:hover { background-color: #ef233c; }

        #driverList { max-height: 180px; overflow-y: auto; margin-top: 5px; background: #181818; border: 1px solid #333; border-radius: 4px; scroll-behavior: smooth; }

        .group-header { background-color: #282828; color: #fff; padding: 10px; cursor: pointer; border: 1px solid #444; border-radius: 6px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .group-header:hover { background-color: #333; }
        .group-content { display: none; padding-left: 10px; border-left: 2px solid #444; margin-bottom: 10px; }
        .group-content.active { display: block; }

        .driver-card { background: #222; margin-top: 5px; padding: 10px; border-radius: 4px; cursor: pointer; border: 1px solid #333; transition: transform 0.1s; position: relative; }
        .driver-card:hover { background: #2a2a2a; border-color: #fca311; }
        .driver-card.selected { border-color: #fca311; background: #332b00; }
        .driver-name-header { padding: 4px; border-radius: 4px; transition: background 0.2s; display: inline-block; width: 100%; }
        .driver-name-header:hover { background-color: #444; }

        .tba-row { font-size: 0.8em; color: #aaa; margin-left: 10px; border-left: 1px solid #444; padding-left: 5px; margin-top: 2px; }

        .scanner-overlay { position: absolute; bottom: 20px; right: 20px; z-index: 1000; background: rgba(0, 0, 0, 0.85); padding: 20px; border-radius: 12px; border: 1px solid #fca311; width: 300px; text-align: center; backdrop-filter: blur(5px); }
        #scanInput { font-size: 1.2em; text-align: center; border-color: #fca311; }
        #scanResult { margin-top: 10px; min-height: 60px; }

        footer { background: #181818; padding: 10px; text-align: center; font-size: 0.8em; color: #555; }

        /* === MAPLIBRE MARKERS STYLING === */
        .driver-marker { display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-shadow: 0 0 2px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.1s; }
        .driver-marker:hover { transform: scale(1.1); z-index: 999; }
        .bag-marker { border-width: 3px; font-size: 10px; z-index: 50; }

        .maplibregl-popup-content { background: #222 !important; color: #eee !important; border: 1px solid #555; border-radius: 6px; padding: 10px; font-family: sans-serif; font-size: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); }
        .maplibregl-popup-tip { border-top-color: #222 !important; border-bottom-color: #222 !important; }
        .maplibregl-popup-close-button { color: #aaa; }

        .input-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .input-tab { flex: 1; padding: 8px; background: #333; border: 1px solid #444; border-radius: 6px 6px 0 0; cursor: pointer; text-align: center; font-size: 0.85em; transition: all 0.2s; }
        .input-tab:hover { background: #444; }
        .input-tab.active { background: #3B3B3B; border-bottom-color: #3B3B3B; color: #fca311; }
        .input-panel { display: none; background: #3B3B3B; padding: 10px; border-radius: 0 0 6px 6px; border: 1px solid #444; border-top: none; }
        .input-panel.active { display: block; }

        .parse-status { font-size: 0.8em; padding: 8px; border-radius: 4px; margin-top: 8px; }
        .parse-status.success { background: rgba(42, 157, 143, 0.2); border: 1px solid #2a9d8f; color: #2a9d8f; }
        .parse-status.error { background: rgba(217, 4, 41, 0.2); border: 1px solid #d90429; color: #d90429; }
        .help-text { font-size: 0.75em; color: #777; margin-top: 5px; line-height: 1.4; }
        .help-text code { background: #222; padding: 1px 4px; border-radius: 3px; color: #aaa; }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>RouteFinder v10 üöÄ</h1>
        </header>

        <div class="main-layout">
            <div class="sidebar">
                <div id="controls">
                    <div class="form-group">
                        <label>1. Packages</label>
                        
                        <div class="input-tabs">
                            <div class="input-tab active" data-tab="text">üìù Text Input</div>
                            <div class="input-tab" data-tab="file">üìÅ File Upload</div>
                        </div>

                        <div class="input-panel active" id="textPanel">
                            <textarea id="textInput" rows="8" placeholder="Paste packages here...
Format Examples:
TBA123456789,19010
TBA987654321,19020"></textarea>
                            <div class="help-text">
                                <strong>Loose:</strong> <code>TBA,ZIP</code> one per line<br>
                                <strong>Bag:</strong> Name on its own line, then TBAs below it<br>
                                <strong>End bag:</strong> Double blank line or new bag name
                            </div>
                            <div style="display: flex; gap: 5px; margin-top: 8px;">
                                <button id="parseText" class="btn-parse">Parse Input</button>
                                <button id="clearText" class="btn-clear" style="width: 80px;">Clear</button>
                            </div>
                            <div id="parseStatus"></div>
                        </div>

                        <div class="input-panel" id="filePanel">
                            <input type="file" id="csvFile" accept=".csv" multiple>
                            <div id="fileInfo" style="font-size:0.8em; color:#aaa; margin-top:5px;"></div>
                            <label style="margin-top:10px; font-size:0.8em; color:#9b5de5;">+ Upload Bags (Optional)</label>
                            <input type="file" id="bagFile" accept=".csv" multiple>
                            <div id="bagList" style="margin-top:5px; font-size:0.8em; color:#ccc;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>2. Fleet</label>
                        <div style="display:flex; gap:5px;">
                            <select id="autoMaxBlock">
                                <option value="2">Max: 2h</option>
                                <option value="2.5">Max: 2.5h</option>
                                <option value="3">Max: 3h</option>
                                <option value="3.5">Max: 3.5h</option>
                                <option value="4" selected>Max: 4h</option>
                            </select>
                            <button id="autoPlan" class="btn-auto">Auto-Plan</button>
                        </div>
                        <button id="findRoutes" class="btn-action">Calculate</button>
                    </div>

                    <details open style="margin-bottom: 15px; border: 1px solid #333; padding: 5px; border-radius: 4px;">
                        <summary style="cursor:pointer; font-size:0.9em; color:#aaa;">Manual Driver Add</summary>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <select id="blockTime">
                                <option value="2">2h</option>
                                <option value="2.5">2.5h</option>
                                <option value="3">3h</option>
                                <option value="3.5">3.5h</option>
                                <option value="4">4h</option>
                            </select>
                            <button id="addDriver" class="btn-secondary">+ Add</button>
                        </div>
                        <div style="font-size: 0.7em; color: #666; margin-top: 3px; text-align: right;">
                            Shortcuts: (=) Add, (-) Remove
                        </div>
                        <div id="driverList"></div>
                    </details>
                </div>

                <div id="resultsArea" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0;">Routes</h3>
                        <button class="btn-reset" onclick="resetMapFilter()" style="width:auto; padding:5px 10px; font-size:0.8em;">Show All Map</button>
                    </div>
                    <div style="font-size:0.8em; color:#aaa; margin-bottom:5px; text-align:center;">Click Name to Copy ‚Ä¢ Click Card to Filter</div>
                    <div id="routeList"></div>
                    <div style="margin-top:20px;">
                        <button id="exportScannerCsv" class="btn-secondary">Export Lookup CSV</button>
                    </div>
                </div>
            </div>

            <div class="map-area">
                <div id="dashboard" class="dashboard-bar">
                    <div class="stat-box">
                        <div class="stat-item"><strong id="statRoutes">0</strong> Routes</div>
                        <div class="stat-item"><strong id="statPkgs">0</strong> Packages</div>
                        <div class="stat-item"><strong id="statStops">0</strong> Locations</div>
                    </div>
                    <div class="zip-dropdown">
                        <button class="zip-btn" onclick="toggleZipMenu()">üìç Zip Code Breakdown ‚ñº</button>
                        <div id="zipMenu" class="zip-content"></div>
                    </div>
                </div>

                <div id="map"></div>

                <div id="scanPanel" class="scanner-overlay" style="display:none;">
                    <div style="font-weight:bold; color:#fca311; margin-bottom:5px;">SCANNER READY</div>
                    <input type="text" id="scanInput" placeholder="Scan Barcode (Last 4)...">
                    <div id="scanResult">
                        <div id="driverDisplay" style="font-size: 40px; font-weight: bold; color: #fff;">--</div>
                        <div id="stopDisplay" style="font-size: 16px; color: #aaa;">Waiting...</div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            &copy; 2025 RouteFinder - Developed by Alp Usta - Amazon @ustaseza
        </footer>
    </div>

    <script>
        // STATE
        let map;
        let mapLayers = []; 
        let loosePackages = [];
        let bagFiles = [];
        let drivers = [];
        let allCalculatedRoutes = [];
        let tbaLookup = {};

        // UNIQUE COLOR PALETTE
        const DRIVER_COLORS = [
            '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
            '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe',
            '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000',
            '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080',
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
            '#dfe6e9', '#fd79a8', '#00b894', '#e17055', '#0984e3'
        ];

        // INIT MAP
        function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                center: [-75.305, 40.101],
                zoom: 9,
                pitch: 40,
                bearing: 0,
                antialias: true
            });
            map.addControl(new maplibregl.NavigationControl());
        }
        window.onload = initMap;

        // TABS
        document.querySelectorAll('.input-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.input-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
            });
        });

        // PARSERS
        function parseTextInput(text) {
            const lines = text.split('\n');
            const parsed = { loosePackages: [], bags: [] };
            let currentBag = null;
            let emptyLineCount = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') {
                    emptyLineCount++;
                    if (emptyLineCount >= 2 && currentBag) {
                        if (currentBag.items.length > 0) parsed.bags.push(currentBag);
                        currentBag = null;
                    }
                    continue;
                }
                emptyLineCount = 0;
                const isTbaLine = line.includes(',') && /TBA\d+/i.test(line);

                if (isTbaLine) {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const tba = parts[0].trim().toUpperCase();
                        const postal = parts[1].trim();
                        if (tba && postal) {
                            if (currentBag) currentBag.items.push({ tba, postal });
                            else parsed.loosePackages.push({ tba, postal });
                        }
                    }
                } else {
                    if (currentBag && currentBag.items.length > 0) parsed.bags.push(currentBag);
                    currentBag = { name: line, items: [] };
                }
            }
            if (currentBag && currentBag.items.length > 0) parsed.bags.push(currentBag);
            return parsed;
        }

        document.getElementById('parseText').addEventListener('click', () => {
            const text = document.getElementById('textInput').value;
            const statusEl = document.getElementById('parseStatus');
            if (!text.trim()) {
                statusEl.className = 'parse-status error';
                statusEl.textContent = '‚ö†Ô∏è No input to parse';
                return;
            }
            const parsed = parseTextInput(text);
            loosePackages = parsed.loosePackages;
            bagFiles = parsed.bags;
            const total = parsed.loosePackages.length + parsed.bags.reduce((s, b) => s + b.items.length, 0);
            if (total === 0) {
                statusEl.className = 'parse-status error';
                statusEl.textContent = '‚ö†Ô∏è No valid packages found.';
            } else {
                statusEl.className = 'parse-status success';
                statusEl.textContent = `‚úì Loaded ${total} packages`;
                document.getElementById('fileInfo').textContent = `${total} pkgs from text`;
                renderBagList();
            }
        });

        document.getElementById('clearText').addEventListener('click', () => {
            document.getElementById('textInput').value = '';
            document.getElementById('parseStatus').innerHTML = '';
            loosePackages = [];
            bagFiles = [];
            document.getElementById('fileInfo').textContent = '';
            renderBagList();
        });

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 1) return null;
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            const pIdx = headers.indexOf('postal');
            const tIdx = headers.indexOf('tba');
            if (pIdx === -1 || tIdx === -1) return null;
            const pkgs = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const d = lines[i].split(',');
                pkgs.push({ postal: d[pIdx].trim(), tba: d[tIdx].trim() });
            }
            return pkgs;
        }

        document.getElementById('csvFile').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                const res = parseCSV(evt.target.result);
                if (res) { loosePackages = res; document.getElementById('fileInfo').textContent = `${res.length} pkgs loaded`; }
            };
            r.readAsText(f);
        });

        document.getElementById('bagFile').addEventListener('change', (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const res = parseCSV(evt.target.result);
                    if (res) {
                        bagFiles.push({ name: file.name, items: res });
                        renderBagList();
                    }
                };
                reader.readAsText(file);
            });
            document.getElementById('bagFile').value = "";
        });

        function renderBagList() {
            const l = document.getElementById('bagList');
            l.innerHTML = '';
            bagFiles.forEach((b, i) => {
                l.innerHTML += `
                    <div style="display:flex; justify-content:space-between; margin-top:2px; padding:2px; border-bottom:1px solid #333;">
                        <span>üì¶ ${b.name} (${b.items.length})</span>
                        <span style="color:#d90429;cursor:pointer;font-weight:bold;" onclick="removeBag(${i})">x</span>
                    </div>`;
            });
        }
        window.removeBag = (i) => { bagFiles.splice(i, 1); renderBagList(); };

        function addManualDriver() {
            const blockSelect = document.getElementById('blockTime');
            const h = parseFloat(blockSelect.value);
            drivers.push({ id: drivers.length + 1, maxHours: h, maxPackages: 45 });
            renderDriverList();
            const container = document.getElementById('driverList');
            setTimeout(() => container.scrollTop = container.scrollHeight, 0);
        }

        window.removeDriver = (index = -1) => {
            if (drivers.length === 0) return;
            if (index > -1) drivers.splice(index, 1);
            else drivers.pop();
            reindexDrivers();
            renderDriverList();
        };

        function reindexDrivers() { drivers.forEach((d, i) => { d.id = i + 1; }); }

        function renderDriverList() {
            const l = document.getElementById('driverList');
            l.innerHTML = '';
            drivers.forEach((d, i) => {
                const div = document.createElement('div');
                div.className = 'driver-item';
                div.innerHTML = `
                    <span style="display:flex; align-items:center;">
                        <span style="color:#fca311; font-weight:bold; margin-right:8px;">D${d.id}</span> 
                        <span>${d.maxHours}h Block</span>
                    </span>
                    <button class="btn-remove-driver" onclick="removeDriver(${i})" title="Remove Driver">√ó</button>
                `;
                l.appendChild(div);
            });
            const calcBtn = document.getElementById('findRoutes');
            if (drivers.length > 0) {
                calcBtn.textContent = `Calculate (${drivers.length} Drivers)`;
                calcBtn.style.opacity = '1';
            } else {
                calcBtn.textContent = 'Calculate';
            }
        }

        document.getElementById('addDriver').addEventListener('click', addManualDriver);
        document.addEventListener('keydown', (e) => {
            const activeTag = document.activeElement.tagName.toLowerCase();
            if (activeTag === 'input' || activeTag === 'textarea' || activeTag === 'select') return;
            if (e.key === '=' || e.key === '+') { e.preventDefault(); addManualDriver(); }
            if (e.key === '-' || e.key === '_') { e.preventDefault(); removeDriver(); }
        });

        document.getElementById('autoPlan').addEventListener('click', () => {
            if (loosePackages.length === 0 && bagFiles.length === 0) return alert("Upload CSV or parse text input first");
            const maxH = parseFloat(document.getElementById('autoMaxBlock').value);
            document.getElementById('autoPlan').textContent = 'Thinking...';
            let vFleet = [];
            for (let i = 0; i < 200; i++) vFleet.push({ id: i + 1, maxHours: maxH, maxPackages: 48 });
            runBackend(vFleet, 'auto', maxH);
        });

        document.getElementById('findRoutes').addEventListener('click', () => {
            if (drivers.length === 0) return alert("Add drivers or use Auto-Plan");
            document.getElementById('findRoutes').textContent = 'Calculating...';
            runBackend(drivers, 'manual', 0);
        });

        function runBackend(driverSet, mode, baseMax) {
            fetch('/calculate-routes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loosePackages, bags: bagFiles, drivers: driverSet, mode: mode })
            })
                .then(res => res.json())
                .then(routes => {
                    const active = routes.filter(r => r.route.length > 0);
                    allCalculatedRoutes = active;
                    if (mode === 'auto') {
                        const blocks = [2, 2.5, 3, 3.5, 4];
                        drivers = [];
                        active.forEach((r, i) => {
                            if (r.driverId.toString().includes("OVERFLOW")) {
                                drivers.push({ id: "OVERFLOW", maxHours: 0, maxPackages: 0 });
                                return;
                            }
                            const needed = r.totalHours;
                            let rec = baseMax;
                            for (let b of blocks) if (b >= needed) { rec = b; break; }
                            if (rec > baseMax) rec = baseMax;
                            r.driverMax = rec;
                            r.driverId = i + 1;
                            drivers.push({ id: i + 1, maxHours: baseMax, maxPackages: 48, recommendedHours: rec });
                        });
                        renderDriverList();
                        // REMOVED ALERT: alert(`Plan: ${active.length} Routes Generated.`);
                    }
                    document.getElementById('autoPlan').textContent = 'Auto-Plan';
                    const dLen = drivers.length;
                    document.getElementById('findRoutes').textContent = dLen > 0 ? `Calculate (${dLen} Drivers)` : 'Calculate';
                    document.getElementById('resultsArea').style.display = 'block';
                    document.getElementById('scanPanel').style.display = 'block';
                    document.getElementById('dashboard').style.display = 'flex'; // Show Dashboard
                    document.getElementById('scanInput').focus();
                    
                    renderGroupedView(active);
                    buildMap(active);
                    buildLookup(active);
                    updateDashboard(active);
                })
                .catch(e => alert(e.message));
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard(routes) {
            const totalRoutes = routes.length;
            let totalPkgs = 0;
            let totalStops = 0;
            let zipMap = {};

            routes.forEach(r => {
                const isOverflow = r.driverId.toString().includes("OVERFLOW");
                const color = isOverflow ? "#666" : DRIVER_COLORS[(r.driverId - 1) % DRIVER_COLORS.length];
                const dName = isOverflow ? "Overflow" : `D${r.driverId}`;

                r.route.forEach((stop, i) => {
                    if (i > 0) {
                        const count = stop.tbas ? stop.tbas.length : 0;
                        totalPkgs += count;
                        totalStops++;

                        // Extract Zip from Address (simple regex for US zip)
                        const zipMatch = stop.address.match(/\b\d{5}\b/);
                        if (zipMatch) {
                            const zip = zipMatch[0];
                            if (!zipMap[zip]) zipMap[zip] = new Set();
                            zipMap[zip].add({ name: dName, color: color });
                        }
                    }
                });
            });

            document.getElementById('statRoutes').innerText = totalRoutes;
            document.getElementById('statPkgs').innerText = totalPkgs;
            document.getElementById('statStops').innerText = totalStops;

            // Build Zip Menu
            const menu = document.getElementById('zipMenu');
            menu.innerHTML = '';
            Object.keys(zipMap).sort().forEach(zip => {
                const drivers = Array.from(zipMap[zip]);
                let tags = '';
                drivers.forEach(d => {
                    tags += `<span class="zip-tag" style="background:${d.color}">${d.name}</span>`;
                });
                
                const row = document.createElement('div');
                row.className = 'zip-row';
                row.innerHTML = `<span style="color:#aaa">${zip}</span> <div>${tags}</div>`;
                menu.appendChild(row);
            });
        }

        function toggleZipMenu() {
            document.getElementById('zipMenu').classList.toggle('show');
        }

        // Close dropdown if clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.zip-btn')) {
                const dropdowns = document.getElementsByClassName("zip-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) {
                        dropdowns[i].classList.remove('show');
                    }
                }
            }
        }

        function renderGroupedView(routes) {
            const container = document.getElementById('routeList');
            container.innerHTML = '';
            const groups = {};
            routes.forEach(r => {
                let key = r.driverId.toString().includes("OVERFLOW") ? "OVERFLOW" : r.driverMax.toString();
                if (!groups[key]) groups[key] = [];
                groups[key].push(r);
            });
            Object.keys(groups).sort().forEach(key => {
                const groupRoutes = groups[key];
                const headerText = key === "OVERFLOW" ? "Unassigned" : `${key} Hour Blocks (${groupRoutes.length})`;
                const color = key === "OVERFLOW" ? "red" : "#2a9d8f";
                const header = document.createElement('div');
                header.className = 'group-header';
                header.style.borderColor = color;
                header.innerHTML = `<span>${headerText}</span> <span style="font-size:0.8em">‚ñº</span>`;
                const content = document.createElement('div');
                content.className = 'group-content';
                header.onclick = () => { toggleAccordion(content); filterMapByGroup(key); };
                groupRoutes.forEach(r => {
                    const card = document.createElement('div');
                    card.className = 'driver-card';
                    let pkgCount = 0;
                    let allTbas = [];
                    r.route.forEach((s, i) => {
                        if (i > 0) { pkgCount += s.tbas.length; allTbas.push(...s.tbas); }
                    });
                    const dName = key === "OVERFLOW" ? "Overflow" : `Driver ${r.driverId}`;
                    const driverColor = key === "OVERFLOW" ? "#666" : DRIVER_COLORS[(r.driverId - 1) % DRIVER_COLORS.length];
                    const nameEl = document.createElement('div');
                    nameEl.className = 'driver-name-header';
                    nameEl.style.fontWeight = 'bold';
                    nameEl.style.color = driverColor;
                    nameEl.style.cursor = 'copy';
                    nameEl.title = 'Click Name to Copy TBAs';
                    nameEl.innerHTML = `<span style="display:inline-block;width:20px;height:20px;background:${driverColor};border-radius:50%;text-align:center;line-height:20px;font-size:10px;color:white;margin-right:5px;">${r.driverId}</span> ${dName} <span style="font-size:0.8em; color:#888;">üìã</span>`;
                    nameEl.onclick = (e) => {
                        e.stopPropagation();
                        const textToCopy = allTbas.join('\r\n');
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            const originalHTML = nameEl.innerHTML;
                            nameEl.innerHTML = `<span style="display:inline-block;width:20px;height:20px;background:${driverColor};border-radius:50%;text-align:center;line-height:20px;font-size:10px;color:white;margin-right:5px;">${r.driverId}</span> ${dName} ‚úÖ`;
                            setTimeout(() => nameEl.innerHTML = originalHTML, 1000);
                        });
                    };
                    const infoEl = document.createElement('div');
                    infoEl.style.fontSize = '0.85em';
                    infoEl.style.color = '#ccc';
                    infoEl.style.marginTop = '2px';
                    infoEl.innerText = `${pkgCount} Pkgs ‚Ä¢ ${formatHours(r.totalHours)} Est`;
                    const listEl = document.createElement('div');
                    listEl.style.marginTop = '5px';
                    listEl.style.paddingTop = '5px';
                    listEl.style.borderTop = '1px solid #444';
                    let listHtml = '';
                    allTbas.forEach(t => listHtml += `<div class="tba-row">${t}</div>`);
                    listEl.innerHTML = listHtml;
                    card.appendChild(nameEl);
                    card.appendChild(infoEl);
                    card.appendChild(listEl);
                    card.onclick = () => {
                        filterMapByDriver(r.driverId);
                        document.querySelectorAll('.driver-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                    };
                    content.appendChild(card);
                });
                container.appendChild(header);
                container.appendChild(content);
            });
        }

        function toggleAccordion(el) {
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        function createNumberedMarker(lat, lng, number, color, isBag = false) {
            const el = document.createElement('div');
            el.className = isBag ? 'driver-marker bag-marker' : 'driver-marker';
            const size = isBag ? 32 : 26;
            el.style.width = `${size}px`;
            el.style.height = `${size}px`;
            el.style.backgroundColor = isBag ? '#f1faee' : color;
            el.style.color = isBag ? color : 'white';
            el.style.borderColor = isBag ? color : 'white';
            el.style.fontSize = isBag ? '11px' : '12px';
            el.innerText = number;
            const marker = new maplibregl.Marker({ element: el }).setLngLat([lng, lat]);
            return marker;
        }

        function buildMap(routes) {
            mapLayers.forEach(obj => obj.marker.remove());
            mapLayers = [];
            if (map.getLayer('route-lines')) map.removeLayer('route-lines');
            if (map.getSource('route-lines')) map.removeSource('route-lines');

            let allPoints = [];
            let geoJsonFeatures = [];

            routes.forEach((r) => {
                const isOverflow = r.driverId.toString().includes("OVERFLOW");
                const color = isOverflow ? "#666" : DRIVER_COLORS[(r.driverId - 1) % DRIVER_COLORS.length];
                const driverNum = isOverflow ? "?" : r.driverId;
                const groupKey = isOverflow ? "OVERFLOW" : r.driverMax.toString();

                let lineCoordinates = r.route.map(s => [s.coordinates.lng, s.coordinates.lat]);
                geoJsonFeatures.push({
                    'type': 'Feature',
                    'properties': { 'color': color, 'driverId': r.driverId, 'groupKey': groupKey },
                    'geometry': { 'type': 'LineString', 'coordinates': lineCoordinates }
                });

                r.route.forEach((stop, i) => {
                    if (i === 0 && !isOverflow) return; 
                    const isBag = stop.isBag;
                    const displayNum = isBag ? `B${driverNum}` : driverNum;
                    const marker = createNumberedMarker(stop.coordinates.lat, stop.coordinates.lng, displayNum, color, isBag);

                    const popup = new maplibregl.Popup({ offset: 25, closeButton: false }).setHTML(`
                        <strong style="color:${color}">Driver ${driverNum}</strong><br>
                        ${stop.address}<br>
                        <span style="color:#aaa">${stop.tbas ? stop.tbas.length : 0} packages</span>
                        ${isBag ? '<br><em style="color:#9b5de5">üì¶ Bag</em>' : ''}
                    `);
                    
                    marker.setPopup(popup);
                    marker.addTo(map);
                    mapLayers.push({ marker: marker, driverId: r.driverId, groupKey: groupKey });
                    allPoints.push([stop.coordinates.lng, stop.coordinates.lat]);
                });
            });

            // GHOST MODE LINES
            map.addSource('route-lines', {
                'type': 'geojson',
                'data': { 'type': 'FeatureCollection', 'features': geoJsonFeatures }
            });

            map.addLayer({
                'id': 'route-lines',
                'type': 'line',
                'source': 'route-lines',
                'layout': { 'line-join': 'round', 'line-cap': 'round' },
                'paint': {
                    'line-color': ['get', 'color'],
                    'line-width': 3,
                    'line-opacity': 0.4  // Increased to 0.4 for better visibility (was 0.15)
                }
            });

            if (allPoints.length) {
                const bounds = new maplibregl.LngLatBounds();
                allPoints.forEach(p => bounds.extend(p));
                map.fitBounds(bounds, { padding: 80 });
            }
        }

        // --- FILTERS (FOCUS MODE) ---
        function filterMapByGroup(groupKey) {
            mapLayers.forEach(obj => {
                const el = obj.marker.getElement();
                if (obj.groupKey === groupKey) {
                    el.style.display = '';
                } else {
                    el.style.display = 'none';
                }
            });
            if (map.getLayer('route-lines')) {
                map.setFilter('route-lines', ['==', 'groupKey', groupKey]);
                map.setPaintProperty('route-lines', 'line-opacity', 0.8);
                map.setPaintProperty('route-lines', 'line-width', 4);
            }
        }

        function filterMapByDriver(dId) {
            // MARKERS: Hide everyone except selected
            mapLayers.forEach(obj => {
                const el = obj.marker.getElement();
                if (obj.driverId === dId) {
                    el.style.display = '';
                    el.style.zIndex = '1000'; 
                } else {
                    el.style.display = 'none';
                }
            });

            // LINES: Focus Mode
            if (map.getLayer('route-lines')) {
                map.setFilter('route-lines', ['==', 'driverId', dId]);
                map.setPaintProperty('route-lines', 'line-opacity', 1.0); // Neon Bright
                map.setPaintProperty('route-lines', 'line-width', 6);    // Extra Thick
            }
        }

        window.resetMapFilter = () => {
            mapLayers.forEach(obj => {
                const el = obj.marker.getElement();
                el.style.display = ''; 
                el.style.zIndex = ''; 
            });
            document.querySelectorAll('.driver-card').forEach(c => c.classList.remove('selected'));

            if (map.getLayer('route-lines')) {
                map.setFilter('route-lines', null); 
                map.setPaintProperty('route-lines', 'line-opacity', 0.4); // Back to Default
                map.setPaintProperty('route-lines', 'line-width', 3);
            }
        };

        function formatHours(h) { const hr = Math.floor(h); const mn = Math.round((h - hr) * 60); return `${hr}h ${mn}m`; }

        function buildLookup(routes) {
            tbaLookup = {};
            routes.forEach(r => r.route.forEach((s, i) => {
                if (i > 0) s.tbas.forEach(t => tbaLookup[t.trim().toUpperCase()] = { d: r.driverId, s: i, z: s.address });
            }));
        }

        document.getElementById('scanInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const val = e.target.value.trim().toUpperCase();
                e.target.value = '';
                const dDisp = document.getElementById('driverDisplay');
                const sDisp = document.getElementById('stopDisplay');
                let info = tbaLookup[val];
                let foundTba = val;
                if (!info) {
                    const allTbas = Object.keys(tbaLookup);
                    const matches = allTbas.filter(tba => tba.endsWith(val));
                    if (matches.length === 1) { foundTba = matches[0]; info = tbaLookup[foundTba]; }
                    else if (matches.length > 1) {
                        dDisp.style.color = '#fca311';
                        dDisp.textContent = 'MULTIPLE';
                        sDisp.textContent = `Found ${matches.length} matches ending in "${val}". Scan more digits.`;
                        window.speechSynthesis.cancel();
                        window.speechSynthesis.speak(new SpeechSynthesisUtterance("Multiple matches"));
                        return;
                    }
                }
                if (info) {
                    dDisp.style.color = '#2a9d8f';
                    const isOverflow = info.d.toString().includes("OVERFLOW");
                    dDisp.textContent = isOverflow ? "OVERFLOW" : `DRIVER ${info.d}`;
                    sDisp.innerHTML = `Stop #${info.s}<br><span style="font-size:0.8em; color:#888;">${foundTba}</span>`;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(isOverflow ? "Overflow" : "Driver " + info.d));
                } else {
                    dDisp.style.color = '#d90429';
                    dDisp.textContent = 'NOT FOUND';
                    sDisp.textContent = 'Check TBA or Overflow';
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance("Not found"));
                }
            }
        });
        document.getElementById('scanInput').addEventListener('blur', () => setTimeout(() => document.getElementById('scanInput').focus(), 100));

        document.getElementById('exportScannerCsv').addEventListener('click', () => {
            let csv = "TBA,DRIVER,STOP,ZIP\n";
            allCalculatedRoutes.forEach(r => {
                r.route.forEach((s, i) => {
                    if (i > 0) s.tbas.forEach(t => csv += `${t.trim()},${r.driverId},${i},${s.address}\n`);
                });
            });
            const b = new Blob([csv], { type: 'text/csv' });
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = `Lookup.csv`; a.click();
        });
    </script>
</body>
</html>